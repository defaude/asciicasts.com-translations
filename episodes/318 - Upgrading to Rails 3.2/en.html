<p>Rails 3.2 has just been released and there&rsquo;s a great post on the <a href="http://weblog.rubyonrails.org/2012/1/20/rails-3-2-0-faster-dev-mode-routing-explain-queries-tagged-logger-store">official blog</a> that explains some of the changes. The more significant of these include a faster development mode which now only reloads the files which have changed since the last request. There&rsquo;s also an entirely new routing engine called Journey which is also much quicker. In this episode we&rsquo;ll show you how to upgrade a Rails 3.1 application to Rails 3.2 and some of its new features.</p>

<h3>Upgrading an Application</h3>

<p>To upgrade an existing Rails 3.1 app to Rails 3.2 the first thing we need to do is to modify its gemfile.</p> 

``` /Gemfile
source 'http://rubygems.org'

gem 'rails', '3.2.0'

gem 'sqlite3'

# Gems used only for assets and not required
# in production environments by default.
group :assets do
  gem 'sass-rails', "  ~> 3.2.3"
  gem 'coffee-rails', "~> 3.2.1"
  gem 'uglifier', '>=1.0.3'
end

gem 'jquery-rails'
```

<p>We&rsquo;ve upgraded the rails gem to version <code>3.2.0</code> and we&rsquo;ve also changed the gems in the assets group so that the version numbers match those used in a new Rails 3.2 application. To update everything to the latest version we&rsquo;ll need to run <code>bundle update</code>.</p>

<p>As well as modifying the gemfile there&rsquo;s some additional environment configuration that we can set to make our application match a new Rails 3.2 application. In the development config file we&rsquo;ll add these lines.</p>

``` /config/environments/development.rb
# Raise exception on mass assignment protection for Active Record models
config.active_record.mass_assignment_sanitizer = :strict

# Log the query plan for queries taking more than this (works
# with SQLite, MySQL, and PostgreSQL)
config.active_record.auto_explain_threshold_in_seconds = 0.5
```

<p>The first of these sets <code>mass_assignment_sanitizer</code> to <code>:strict</code> which will raise an exception if the mass assignment goes against the protection. The second line sets the auto-explain threshold to <code>0.5</code>. This means that any database queries that take more than half a second to process will have an EXPLAIN query run against them and the output from that command will be written to the log. It&rsquo;s a good idea to copy the <code>mass_assignment_sanitizer</code> option to the test environment too to match new Rails 3.2 apps and also to remove the following line as it&rsquo;s no longer generated by default.</p>

``` /config/environments/test.rb
# Allow pass debug_assets=true as a query parameter to load pages with unpackaged assets
config.assets.allow_debugging = true
```

<h3>EXPLAIN Queries</h3>

<p>Now that our application has been upgraded to Rails 3.2 we&rsquo;ll show some of its features in the Rails console. We&rsquo;ve already mentioned that long-running database queries will automatically have an EXPLAIN query run against them, but we can also trigger this in the console by running <code>explain</code> against an Active Record query.</p>

``` terminal
1.9.2-p290 :001 > Product.order(:name).explain
  Product Load (0.6ms)  SELECT "products".* FROM "products" ORDER BY name
  EXPLAIN (0.1ms)  EXPLAIN QUERY PLAN SELECT "products".* FROM "products" ORDER BY name
 => "EXPLAIN for: SELECT \"products\".* FROM \"products\"  ORDER BY name\n0|0|0|SCAN TABLE products (~1000000 rows)\n0|0|0|USE TEMP B-TREE FOR ORDER BY\n"
``` 

<p>We can print out the output in a cleaner way with <code>puts _</code>.</p>

``` terminal
1.9.2-p290 :002 > puts _
EXPLAIN for: SELECT "products".* FROM "products"  ORDER BY name
0|0|0|SCAN TABLE products (~1000000 rows)
0|0|0|USE TEMP B-TREE FOR ORDER BY
```

<p>This EXPLAIN query isn&rsquo;t very interesting as it&rsquo;s only for a simple query but this feature is much more useful for complex JOIN queries. If there&rsquo;s a place in our application that we know runs a slow database query and we don&rsquo;t want an EXPLAIN query generated each time we can wrap the query in a <code>silence_auto_explain</code> block like this:</p>

``` terminal
1.9.2-p290 :003 > ActiveRecord::Base.silence_auto_explain { Product.order(:name) }
```

<p>The query inside the block won&rsquo;t generate an EXPLAIN query now no matter how long it takes to run.</p>

<h3>New ActiveRecord Methods</h3>

<p>Another useful new feature of Rails 3.2 is the pluck method. This allows us to pass in a column name and will return all the values for that column.</p>

``` terminal
1.9.2-p290 :005 > Product.pluck(:name)
   (0.2ms)  SELECT name FROM "products" 
 => ["Settlers of Catan", "Flux Capacitor", "Technodrome", "Agricola", "Millennium Falcon", "Ryan's Cheesecake", "Answer to Everything"]
``` 
 
<p>We can do this for any column and it will return all of its values in an array of the appropriate data type.</p>

``` terminal
1.9.2-p290 :007 > Product.pluck(:id)
   (0.2ms)  SELECT id FROM "products" 
 => [1, 2, 3, 4, 5, 6, 7]
``` 
 
<p>On a similar note if we use the select clause to restrict the columns that are returned there&rsquo;s a new uniq method that we can call. We can use this, for example, to return one product for each unique name.</p>

``` terminal
1.9.2-p290 :009 > Product.select(:name).uniq
  Product Load (0.3ms)  SELECT DISTINCT name FROM "products" 
 => [#<Product name: "Agricola">, #<Product name: "Answer to Everything">, #<Product name: "Flux Capacitor">, #<Product name: "Millennium Falcon">, #<Product name: "Ryan's Cheesecake">, #<Product name: "Settlers of Catan">, #<Product name: "Technodrome">]
``` 
 
<p>Another related new feature, first_or_create, is designed to work with a <code>where</code> clause.</p>

``` terminal
1.9.2-p290 :010 > Product.where(name: "Foo").first_or_create!
```

<p>We&rsquo;ve used the optional bang here so that an exception will be raised if there are any validation errors. The code above works in a similar way to <code>find_or_create_by_name</code>. The first time we run it it will create a new <code>Product</code> with that <code>name</code> (assuming there isn&rsquo;t already an existing one); when we run it again it will return the matching product that&rsquo;s found. What&rsquo;s nice about this approach is that we can pass additional attributes to the <code>create</code> call like this:</p>

``` terminal
1.9.2-p290 :011 > Product.where(name: "Foo").first_or_create!(price: 5)
```

<p>Any newly-created records will inherit these attributes but they won&rsquo;t be taken into account when searching for a <code>Product</code>.</p>

<p>The final new method we&rsquo;ll show you is called <code>safe_constantize</code> and is called against a string.</p>

``` terminal
1.9.2-p290 :007 > "Product".safe_constantize
 => Product(id: integer, name: string, price: decimal, description: text, discontinued: boolean, created_at: datetime, updated_at: datetime)
``` 

<p>This will return a matching constant if one exists. The difference between this and the normal <code>constantize</code> method is that it returns <code>nil</code> if no matching constant is found instead of throwing an exception.</p>

<h3>New Migration Features</h3>

<p>Next we&rsquo;ll show some new options that we can use when we generate a migration. Let&rsquo;s say that we&rsquo;re generating a new <code>ProductVariation</code> model. Here&rsquo;s our migration.</p>

``` terminal
$ rails g model product_variation product_id:integer:index name 'price:decimal{7,2}'
```

<p>This migration uses three new features. We want a <code>ProductVariation</code> to belong to a <code>Product</code> and so we&rsquo;ve specified <code>product_id</code> as one of the columns. In Rails 3.2 we can specify a third <code>index</code> option and this will automatically add an index to the column.</p>

<p>We want our <code>ProductVariation</code> model to have a string <code>name</code> column. Normally we&rsquo;d use <code>name:string</code> in our migration to do this but <code>string</code> is now the default so we don&rsquo;t need to specify a datatype for a string column. Finally if we&rsquo;re defining a <code>decimal</code> field we can pass in options to specify the <code>precision</code> and <code>scale</code> of that datatype. Note that it&rsquo;s necessary to quote this part of the migration so that the shell doesn&rsquo;t try to modify it.</p>

<p>Here&rsquo;s what the generated migration looks like.</p>

``` /db/migrations/20120101000000_create_product_variations.rb
class CreateProductVariations < ActiveRecord::Migration
  def change
    create_table :product_variations do |t|
      t.integer :product_id
      t.string :name
      t.decimal :price, :precision => 7, :scale => 2

      t.timestamps
    end
    add_index :product_variations, :product_id
  end
end
```

<p>We can see the products we specified in this migration and in it the <code>product_id</code> field has an index defined, the <code>name</code> field has defaulted to <code>string</code> and the <code>price</code> field has <code>precision</code> and <code>scale</code> options defined.</p>

<p>Speaking of generators you might have some options that you always use when you&rsquo;re generating a new Rails app such as specifying a specific database or excluding unit tests. We can make these options the default by storing them in a <code>.railsrc</code> file in our home directory.</p>

``` terminal
$ echo -d postgresql -T > ~/.railsrc
```

<p>When we create a new Rails app now those options will be automatically added.</p>

``` terminal
$ rails new blog
Using -d postgresql -T from /Users/eifion/.railsrc 
```

<h3>Key-Value Storage</h3>

<p>ActiveRecord now comes with a new way to define key-value storage in models. For example lets say that in our <code>ProductVariation</code> model we have some attributes such as <code>colour</code> and <code>size</code> and we don&rsquo;t want separate database columns for each one. We can use the new <code>store</code> method to store these values in a single column.</p>

``` /app/models/product_variation.rb
class ProductVariation < ActiveRecord::Base
  store :properties, accessors: [:colour, :size]
end
```

<p>The first argument here contains the name of the column that the values will be stored in and the second defines the properties we want to store. We&rsquo;ll still need to create this database column so we&rsquo;ll need a database migration as well.</p>

``` terminal
$ rails g migration add_properties_to_product_variations properties:text
```

<p>Don&rsquo;t forget to run <code>rake db:migrate</code> to add the column to the database.</p>

<p>We&rsquo;ll demonstrate this in the console. We can create a new <code>ProductVariation</code> and give it <code>colour</code> and <code>size</code> attributes in the same way we would for normal attributes.</p>

``` terminal
Loading development environment (Rails 3.2.0)
1.9.2-p290 :001 > p = ProductVariation.new(colour: 'blue', size: 3)
 => #<ProductVariation id: nil, product_id: nil, name: nil, price: nil, created_at: nil, updated_at: nil, properties: {:colour=>"blue", :size=>3}>
``` 
 
<p>We can access these attributes just as we would any others.</p>

``` terminal
1.9.2-p290 :003 > p.colour
 => "blue"
``` 
 
<p>We can access them through the <code>properties</code> hash too.</p>

``` terminal
1.9.2-p290 :004 > p.properties[:colour]
 => "blue" 
``` 
 
<p>As these attributes aren&rsquo;t actual database columns we can&rsquo;t search by them but this is a convenient way to access a hash of attributes.</p>

<h3>Tagged Logging</h3>

<p>There&rsquo;s one more feature that we&rsquo;ll show you, tagged logging. This is something that&rsquo;s normally only done in production mode but we&rsquo;ll add to our development environment so that we can demonstrate it. We do this by setting the <code>log_tags</code> configuration option and we set it to an array of attributes that are the names of methods that will be called against request.</p>

``` /config/environments/development.rb
config.log_tags = [:uuid, :remote_ip]
```

<p>We&rsquo;ve used uuid which is a new method in Rails 3.2 which returns a unique request id and which lets us determine which request the log came from. The other is the remote IP address. When we start the server up now and make a request each line in the log is tagged with those values.</p>

``` log
[ab939dfca5d57843ea4c695cab6f721d] [127.0.0.1] 

Started GET "/" for 127.0.0.1 at 2012-01-27 21:52:58 +0000
[ab939dfca5d57843ea4c695cab6f721d] [127.0.0.1] Processing by ProductsController#index as HTML
[ab939dfca5d57843ea4c695cab6f721d] [127.0.0.1]   Product Load (0.3ms)  SELECT "products".* FROM "products" 
[ab939dfca5d57843ea4c695cab6f721d] [127.0.0.1]   Rendered products/index.html.erb within layouts/application (22.0ms)
[ab939dfca5d57843ea4c695cab6f721d] [127.0.0.1] Completed 200 OK in 81ms (Views: 73.1ms | ActiveRecord: 0.3ms)
[98eec5f8976586c1165b981797086b6a] [127.0.0.1] 
```

<p>This becomes very useful in production when there are multiple Rails instances writing to the log files. This will enable us to separate out the log entries that are associated with a specific request.</p> 